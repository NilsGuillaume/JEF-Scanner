<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Beats without Borders - Donations Party</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />

  <!-- PayPal SDK (standard buttons, no hosted-buttons) -->
  <script 
    src="https://www.paypal.com/sdk/js?client-id=BAA6Z2kU6-TesiMjcbBozmJQ2pDPYMmF4VODKR07Gn0n-tQjK8XFlfo_ENTXTOIhGLHluhWN4Br2Z0_ukQ&disable-funding=venmo&currency=EUR">
  </script>

  <style>
    :root{
      --bg:#0b0f14; --card:#111827; --muted:#9aa4b2; --text:#e6edf3; --line:#1f2937;
      --accent:#60a5fa;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7fafc; --card:#ffffff; --text:#0b1220; --line:#e5e7eb; --muted:#4b5563; --accent:#2563eb; }
    }
    *{ box-sizing:border-box }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial }
    a{ color:var(--accent); text-decoration:none }
    header{ border-bottom:1px solid var(--line); position:sticky; top:0; backdrop-filter:blur(6px); background:color-mix(in oklab, var(--bg) 85%, transparent) }
    .wrap{ max-width:980px; margin:0 auto; padding:20px }
    .brand{ font-weight:700; letter-spacing:.2px }
    .grid{ display:grid; grid-template-columns:1.1fr .9fr; gap:24px; margin-top:24px }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr } }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:22px }
    .meta{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px }
    @media (max-width:700px){ .meta{ grid-template-columns:1fr } }
    .item{ background:color-mix(in oklab, var(--card) 90%, var(--bg)); border:1px dashed var(--line); padding:12px 14px; border-radius:12px }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; border:1px solid #10b98155; color:#10b981; background:#10b9811a }
    .price{ font-size:clamp(24px, 3vw, 32px); font-weight:800 }
    .muted{ color:var(--muted) }
    .divider{ height:1px; background:var(--line); margin:16px 0 }
    .panel{ display:flex; flex-direction:column; gap:14px }
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#000a; z-index:9999; font-size:20px }
    .overlay.show{ display:flex }
    .ticket{ display:none; background:var(--card); border:2px solid var(--accent); border-radius:16px; padding:24px; margin-top:24px; text-align:center; }
    .ticket.show{ display:block; }
    .ticket h2{ color:var(--accent); margin-top:0; }
    .ticket-code{ font-family:monospace; font-size:24px; letter-spacing:4px; background:var(--bg); padding:12px; border-radius:8px; margin:16px 0; }

    /* NEW: simple styling for the form fields */
    .field-group{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:8px;
    }
    .field-label{
      font-size:14px;
      font-weight:500;
    }
    .field-input{
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--line);
      background:color-mix(in oklab, var(--bg) 70%, var(--card));
      color:var(--text);
      font-size:14px;
    }
    .field-input::placeholder{
      color:var(--muted);
    }
    .helper-text{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }

    /* NEW: QR code container */
    #qrcode{
      margin:16px auto 0;
      width:160px;
      height:160px;
    }

    /* === Smooth green–blue background — keep this AT THE END === */
    html, body{
      background:
        radial-gradient(35rem 28rem at 22% 18%, rgba(173,219,46,0.45) 0%, rgba(16,185,129,0.30) 40%, transparent 60%),
        radial-gradient(36rem 30rem at 62% 18%, rgba(99,102,241,0.55) 0%, rgba(37,99,235,0.35) 40%, transparent 62%),
        radial-gradient(120rem 70rem at 50% -10%, #07233d 0%, #051a30 50%, #041426 100%);
      background-attachment: fixed;
      background-repeat: no-repeat;
    }

    @media (prefers-color-scheme: light){
      html, body{
        background:
          radial-gradient(35rem 28rem at 22% 18%, rgba(163,230,53,0.55) 0%, rgba(34,197,94,0.35) 40%, transparent 60%),
          radial-gradient(36rem 30rem at 62% 18%, rgba(59,130,246,0.55) 0%, rgba(99,102,241,0.35) 40%, transparent 62%),
          linear-gradient(180deg, #eaf3ff 0%, #f5fbff 100%);
        background-attachment: fixed;
        background-repeat: no-repeat;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap" aria-label="Site header">
      <div class="brand">Young Europeans JEF Konstanz e.V.</div>
    </div>
  </header>

  <main class="wrap">
    <section class="hero" aria-labelledby="title">
      <h1 id="title">Beats without Borders – Pre-Sell</h1>
      <p>Wednesday, 26. November 2026 · 22:00 — Kantine, Konstanz</p>
    </section>

    <section class="grid" aria-label="Ticket checkout">
      <!-- Eventinfo -->
      <article class="card">
        <div class="badge" aria-label="ticket status">Available · Limited Places</div>
        <div class="meta">
          <div class="item">
            <div class="muted">Pre-Sell</div>
            <div><strong>1×</strong> Standard ticket</div>
          </div>
          <div class="item">
            <div class="muted">Wenn &amp; Where</div>
            <div>, Wednesday, 26. November 2026 · 22:00<br/>Kantine, Oberlohnstraße 3, 78467 Konstanz</div>
          </div>
        </div>
        <div class="divider"></div>
        <h2 class="price" aria-label="Price">€6.00</h2>
        <p class="muted">E-Ticket will appear on this page after successful payment, in case you closed the page. Try to reopen the page or contact us under konstanz@jef-bw.de </p>
      </article>

      <!-- Zahlung -->
      <aside class="card panel" aria-label="Zahlung">
        <h2 style="margin:0">Checkout</h2>
        <p class="muted" style="margin-top:-6px">Please enter your details and then pay with PayPal or Debit / Credit Card. The ticket will be opened after successful payment.</p>

        <!-- NEW: Name + Email inputs -->
        <div class="field-group">
          <label for="fullName" class="field-label">Name*</label>
          <input
            id="fullName"
            name="fullName"
            type="text"
            class="field-input"
            placeholder="Vor- und Nachname"
            autocomplete="name"
            required
          />
        </div>

        <div class="field-group">
          <label for="email" class="field-label">E-Mail-Adresse*</label>
          <input
            id="email"
            name="email"
            type="email"
            class="field-input"
            placeholder="you@example.com"
            autocomplete="email"
            required
          />
          <p class="helper-text">
            We use this to send you the ticket and to verify your purchase at the entrance.
          </p>
        </div>

        <div class="divider"></div>

        <!-- PayPal Button Container -->
        <div id="paypal-container-SP2E3J2QVPCUJ"></div>
        
      </aside>
    </section>

    <!-- Ticket Anzeige (wird nach Zahlung angezeigt) -->
    <section class="ticket" id="ticket">
      <h2>Your Party Ticket for Beats without Borders</h2>
      <p><strong>Beats without Borders</strong></p>
      <p>Wednesday, 26. November 2026 · 22:00 — Kantine, Konstanz</p>
      
      <div class="ticket-code" id="ticketCode">SG-XXXX-XXXX-XXXX</div>

      <!-- NEW: QR code container -->
      <div id="qrcode" role="img" aria-label="QR code for your ticket"></div>
      
      <p class="muted">This ticket will be scanned upon entry. Please have it ready.</p>
      <button onclick="window.print()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Ticket drucken</button>
    </section>
  </main>

  <!-- Lade-Overlay -->
  <div class="overlay" id="overlay" role="status" aria-live="polite">⏳ Ticket is being produced …</div>

  <!-- QRCode library (client-side QR generation) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // === CONFIG: set your backend URL + password here ===
    const BACKEND_BASE_URL = "https://jef-shop-backend.onrender.com";
    const BACKEND_PASSWORD = "536742513462138247235784210742847562938572591048674267720310648";

    // Use same key name as before to keep behavior consistent
    const TICKET_STORAGE_KEY = "springGalaTicket";

    document.addEventListener('DOMContentLoaded', function() {
      // On load, just show existing ticket if we have one
      checkExistingTicket();
    });

    // Create ticket after PayPal confirms payment
    async function generateAndShowTicket() {
      const ticketEl = document.getElementById('ticket');
      const ticketCodeEl = document.getElementById('ticketCode');
      const overlay = document.getElementById('overlay');

      const name = (document.getElementById('fullName').value || "").trim();
      const email = (document.getElementById('email').value || "").trim();

      if (!name || !email) {
        alert('Please enter your name and email address before paying.');
        return;
      }

      overlay.classList.add('show');

      let response;
      let data = null;

      try {
        const url = `${BACKEND_BASE_URL}/ticket-request/${encodeURIComponent(email)},${encodeURIComponent(name)},${encodeURIComponent(BACKEND_PASSWORD)}`;
        response = await fetch(url);

        // Try to parse JSON, even if status is not OK
        try {
          data = await response.json();
        } catch (e) {
          data = null;
        }
      } catch (err) {
        console.error('Ticket generation network error:', err);
        overlay.classList.remove('show');
        alert('We could not reach the ticket server. Please try again or contact us at konstanz@jef-bw.de with your payment confirmation.');
        return;
      }

      // Sold out
      if (response.status === 409) {
        overlay.classList.remove('show');
        alert('Unfortunately, there are no tickets left. If you have already paid, please contact us at konstanz@jef-bw.de.');
        return;
      }

      const ticketCode = data && data.code ? String(data.code) : null;

      if (ticketCode) {
        // Store and show the ticket code
        saveTicketToStorage(ticketCode);
        ticketCodeEl.textContent = ticketCode;
        renderQrCode(ticketCode);

        overlay.classList.remove('show');
        ticketEl.classList.add('show');
        ticketEl.scrollIntoView({ behavior: 'smooth' });

        // If backend returned an error status but still gave a code, warn but keep ticket visible
        if (!response.ok) {
          console.warn('Backend returned non-OK status but included ticket code:', response.status, data);
          alert(
            'Your ticket has been created and is valid (see code and QR on this page), ' +
            'but there was a technical error in the background. Please consider taking a screenshot. ' +
            'If you have questions, contact us at konstanz@jef-bw.de with your ticket code.'
          );
        }
        return;
      }

      // No code at all => real failure
      overlay.classList.remove('show');
      console.error('Ticket creation failed. Response status:', response && response.status, 'data:', data);
      alert('There was an error while creating your ticket. Please contact us at konstanz@jef-bw.de with your payment confirmation.');
    }

    function saveTicketToStorage(ticketCode) {
      localStorage.setItem(TICKET_STORAGE_KEY, ticketCode);
    }

    function checkExistingTicket() {
      const savedTicket = localStorage.getItem(TICKET_STORAGE_KEY);
      if (savedTicket) {
        document.getElementById('ticketCode').textContent = savedTicket;
        document.getElementById('ticket').classList.add('show');
        renderQrCode(savedTicket);
      }
    }

    function renderQrCode(ticketCode) {
      const qrContainer = document.getElementById('qrcode');
      if (!qrContainer || typeof QRCode === 'undefined') return;

      // Clear previous QR code, if any
      qrContainer.innerHTML = "";

      new QRCode(qrContainer, {
        text: ticketCode,
        width: 160,
        height: 160,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    // PayPal Buttons integration: payment itself is the trigger
    paypal.Buttons({
      createOrder: function (data, actions) {
        return actions.order.create({
          purchase_units: [{
            amount: {
              currency_code: 'EUR',
              value: '6.00'
            }
          }]
        });
      },

      onApprove: function (data, actions) {
        return actions.order.capture().then(function (details) {
          console.log('PayPal payment captured:', details);
          // After successful capture, create/send/show the ticket
          generateAndShowTicket();
        });
      },

      onError: function (err) {
        console.error('PayPal Error object:', err);
        try {
          alert('PayPal error: ' + (err && err.message ? err.message : JSON.stringify(err)));
        } catch (e) {
          alert('A PayPal error occurred. Please check the browser console (F12 → Console).');
        }
      },


    }).render("#paypal-container-SP2E3J2QVPCUJ");
  </script>
</body>
</html>
