<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Beats without Borders - Donations Party</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />

  <!-- PayPal SDK -->
  <script 
    src="https://www.paypal.com/sdk/js?client-id=BAA6Z2kU6-TesiMjcbBozmJQ2pDPYMmF4VODKR07Gn0n-tQjK8XFlfo_ENTXTOIhGLHluhWN4Br2Z0_ukQ&components=hosted-buttons&disable-funding=venmo&currency=EUR">
  </script>

  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    /* Deine bestehenden Styles bleiben gleich */
    :root{
      --bg:#0b0f14; --card:#111827; --muted:#9aa4b2; --text:#e6edf3; --line:#1f2937;
      --accent:#60a5fa;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7fafc; --card:#ffffff; --text:#0b1220; --line:#e5e7eb; --muted:#4b5563; --accent:#2563eb; }
    }
    *{ box-sizing:border-box }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial }
    a{ color:var(--accent); text-decoration:none }
    header{ border-bottom:1px solid var(--line); position:sticky; top:0; backdrop-filter:blur(6px); background:color-mix(in oklab, var(--bg) 85%, transparent) }
    .wrap{ max-width:980px; margin:0 auto; padding:20px }
    .brand{ font-weight:700; letter-spacing:.2px }
    .grid{ display:grid; grid-template-columns:1.1fr .9fr; gap:24px; margin-top:24px }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr } }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:22px }
    .meta{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px }
    @media (max-width:700px){ .meta{ grid-template-columns:1fr } }
    .item{ background:color-mix(in oklab, var(--card) 90%, var(--bg)); border:1px dashed var(--line); padding:12px 14px; border-radius:12px }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; border:1px solid #10b98155; color:#10b981; background:#10b9811a }
    .price{ font-size:clamp(24px, 3vw, 32px); font-weight:800 }
    .muted{ color:var(--muted) }
    .divider{ height:1px; background:var(--line); margin:16px 0 }
    .panel{ display:flex; flex-direction:column; gap:14px }
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#000a; z-index:9999; font-size:20px }
    .overlay.show{ display:flex }
    .ticket{ display:none; background:var(--card); border:2px solid var(--accent); border-radius:16px; padding:24px; margin-top:24px; text-align:center; }
    .ticket.show{ display:block; }
    .ticket h2{ color:var(--accent); margin-top:0; }
    .ticket-code{ font-family:monospace; font-size:24px; letter-spacing:4px; background:var(--bg); padding:12px; border-radius:8px; margin:16px 0; }
    
    /* New styles for form and QR code */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; margin-bottom: 6px; font-weight: 600; }
    .form-input { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid var(--line); 
      border-radius: 8px; 
      background: var(--card); 
      color: var(--text);
      font-size: 16px;
    }
    .form-input:focus { 
      outline: none; 
      border-color: var(--accent); 
    }
    .error-message { 
      color: #ef4444; 
      font-size: 14px; 
      margin-top: 4px; 
      display: none; 
    }
    .qr-code { 
      margin: 20px auto; 
      padding: 10px; 
      background: white; 
      border-radius: 8px; 
      display: inline-block; 
    }
    .paypal-button-container { margin-top: 20px; }
    
    /* === Smooth green–blue background — keep this AT THE END === */
    html, body{
      /* keep your existing typography/spacing or omit if already set elsewhere */
      background:
        radial-gradient(35rem 28rem at 22% 18%, rgba(173,219,46,0.45) 0%, rgba(16,185,129,0.30) 40%, transparent 60%),
        radial-gradient(36rem 30rem at 62% 18%, rgba(99,102,241,0.55) 0%, rgba(37,99,235,0.35) 40%, transparent 62%),
        radial-gradient(120rem 70rem at 50% -10%, #07233d 0%, #051a30 50%, #041426 100%);
      background-attachment: fixed;
      background-repeat: no-repeat;
    }

    /* Light scheme variant */
    @media (prefers-color-scheme: light){
      html, body{
        background:
          radial-gradient(35rem 28rem at 22% 18%, rgba(163,230,53,0.55) 0%, rgba(34,197,94,0.35) 40%, transparent 60%),
          radial-gradient(36rem 30rem at 62% 18%, rgba(59,130,246,0.55) 0%, rgba(99,102,241,0.35) 40%, transparent 62%),
          linear-gradient(180deg, #eaf3ff 0%, #f5fbff 100%);
        background-attachment: fixed;
        background-repeat: no-repeat;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap" aria-label="Site header">
      <div class="brand">Young Europeans JEF Konstanz e.V.</div>
    </div>
  </header>

  <main class="wrap">
    <section class="hero" aria-labelledby="title">
      <h1 id="title">Beats without Borders – Pre-Sell</h1>
      <p>Wednesday, 26. November 2026 · 22:00 — Kantine, Konstanz</p>
    </section>

    <section class="grid" aria-label="Ticket checkout">
      <!-- Eventinfo -->
      <article class="card">
        <div class="badge" aria-label="ticket status">Available · Limited Places</div>
        <div class="meta">
          <div class="item">
            <div class="muted">Pre-Sell</div>
            <div><strong>1×</strong> Standard ticket</div>
          </div>
          <div class="item">
            <div class="muted">Wenn &amp; Where</div>
            <div>, Wednesday, 26. November 2026 · 22:00<br/>Kantine, Oberlohnstraße 3, 78467 Konstanz</div>
          </div>
        </div>
        <div class="divider"></div>
        <h2 class="price" aria-label="Price">€6.00</h2>
        <p class="muted">E-Ticket will appear on this page after successful payment, in case you closed the page. Try to reopen the page or contact us under konstanz@jef-bw.de </p>
      </article>

      <!-- Zahlung -->
      <aside class="card panel" aria-label="Zahlung">
        <h2 style="margin:0">Checkout</h2>
        <p class="muted" style="margin-top:-6px">Pay with Paypal or Debit / Credit Card. The ticket will be opened after successful payment.</p>

        <!-- Personal Information Form -->
        <div class="form-group">
          <label class="form-label" for="name">Full Name</label>
          <input type="text" id="name" class="form-input" placeholder="Enter your full name" required>
          <div class="error-message" id="nameError">Please enter your name</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="email">Email Address</label>
          <input type="email" id="email" class="form-input" placeholder="Enter your email" required>
          <div class="error-message" id="emailError">Please enter a valid email address</div>
        </div>

        <!-- PayPal Button Container -->
        <div class="paypal-button-container" id="paypal-container-SP2E3J2QVPCUJ"></div>

        <div class="divider"></div>
        
      </aside>
    </section>

    <!-- Ticket Anzeige (wird nach Zahlung angezeigt) -->
    <section class="ticket" id="ticket">
      <h2>Your Party Ticket for Beats without Borders</h2>
      <p><strong>Beats without Borders</strong></p>
      <p>Wednesday, 26. November 2026 · 22:00 — Kantine, Konstanz</p>
      
      <div class="ticket-code" id="ticketCode">SG-XXXX-XXXX-XXXX</div>
      
      <!-- QR Code Container -->
      <div id="qrCodeContainer"></div>
      
      <p class="muted">This ticket will be scanned upon entry. Please have it ready.</p>
      <button onclick="window.print()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Ticket drucken</button>
    </section>
  </main>

  <!-- Lade-Overlay -->
  <div class="overlay" id="overlay" role="status" aria-live="polite">⏳ Ticket is being produced …</div>

  <script>
    // Backend configuration
    const BACKEND_URL = 'https://jef-shop-backend.onrender.com'; // Replace with your actual backend URL
    const BACKEND_PASSWORD = '536742513462138247235784210742847562938572591048674267720310648'; // Replace with your actual backend password

    // Prüfe beim Laden der Seite auf URL-Parameter
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const paymentStatus = urlParams.get('payment');
      
      if (paymentStatus === 'success') {
        generateAndShowTicket();
      } else {
        // Prüfe auf gespeichertes Ticket
        checkExistingTicket();
      }
    });

    function validateForm() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      let isValid = true;

      // Reset errors
      document.getElementById('nameError').style.display = 'none';
      document.getElementById('emailError').style.display = 'none';

      // Validate name
      if (!name) {
        document.getElementById('nameError').style.display = 'block';
        isValid = false;
      }

      // Validate email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email || !emailRegex.test(email)) {
        document.getElementById('emailError').style.display = 'block';
        isValid = false;
      }

      return isValid;
    }

    async function generateAndShowTicket() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      
      if (!validateForm()) {
        alert('Please fill in all required fields correctly.');
        return;
      }

      const ticket = document.getElementById('ticket');
      const ticketCode = document.getElementById('ticketCode');
      const overlay = document.getElementById('overlay');
      
      // Overlay anzeigen
      overlay.classList.add('show');
      
      try {
        // Call backend API to get ticket
        const response = await fetch(`${BACKEND_URL}/ticket-request/${encodeURIComponent(email)},${encodeURIComponent(name)},${BACKEND_PASSWORD}`);
        
        if (!response.ok) {
          throw new Error('Failed to generate ticket');
        }
        
        const data = await response.json();
        const ticketCodeFromAPI = data.code;
        
        // Display ticket code from API
        ticketCode.textContent = ticketCodeFromAPI;
        
        // Generate QR code
        generateQRCode(ticketCodeFromAPI);
        
        // Save ticket to storage
        saveTicketToStorage(ticketCodeFromAPI);
        
        // Show ticket
        overlay.classList.remove('show');
        ticket.classList.add('show');
        ticket.scrollIntoView({ behavior: 'smooth' });
        
        // URL bereinigen (optional)
        window.history.replaceState({}, document.title, window.location.pathname);
        
      } catch (error) {
        console.error('Error generating ticket:', error);
        overlay.classList.remove('show');
        alert('Error generating ticket. Please contact us at konstanz@jef-bw.de');
      }
    }

    function generateQRCode(ticketCode) {
      const qrCodeContainer = document.getElementById('qrCodeContainer');
      qrCodeContainer.innerHTML = ''; // Clear previous QR code
      
      QRCode.toCanvas(qrCodeContainer, ticketCode, { 
        width: 200,
        margin: 2,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        }
      }, function (error) {
        if (error) {
          console.error('Error generating QR code:', error);
          qrCodeContainer.innerHTML = '<p>QR Code could not be generated</p>';
        } else {
          // Add a class to the canvas for styling
          const canvas = qrCodeContainer.querySelector('canvas');
          if (canvas) {
            canvas.classList.add('qr-code');
          }
        }
      });
    }

    function saveTicketToStorage(ticketCode) {
      localStorage.setItem('springGalaTicket', ticketCode);
      sessionStorage.setItem('currentTicket', ticketCode);
    }

    function checkExistingTicket() {
      const savedTicket = localStorage.getItem('springGalaTicket');
      if (savedTicket) {
        document.getElementById('ticketCode').textContent = savedTicket;
        generateQRCode(savedTicket);
        document.getElementById('ticket').classList.add('show');
      }
    }

    // Modified PayPal Integration to include form validation
    paypal.HostedButtons({
      hostedButtonId: "SP2E3J2QVPCUJ",
      onInit: function (data, actions) {
        // This function is called when the button is initialized
        console.log('PayPal button initialized');
      },
      onClick: function () {
        // Validate form before proceeding with PayPal
        if (!validateForm()) {
          // Prevent PayPal from opening if form is invalid
          return false;
        }
        return true;
      },
      onError: function (err) {
        console.error('PayPal Error:', err);
        alert('There was an error with your payment. Please try again or contact us under: konstanz@jef-bw.de .');
      },
      onCancel: function (data) {
        console.log('Payment cancelled');
      }
    }).render("#paypal-container-SP2E3J2QVPCUJ");

    // Add form validation on input change
    document.getElementById('name').addEventListener('input', validateForm);
    document.getElementById('email').addEventListener('input', validateForm);
  </script>
</body>
</html>
