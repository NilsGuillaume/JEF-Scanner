<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Ticket Check‚ÄëIn (html5‚Äëqrcode + CSV)</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --ok:#10b981; --err:#ef4444; --fg:#e5e7eb; --btn:#2563eb; --btnText:#ffffff; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background: radial-gradient(1200px 800px at 50% -10%, #1f2937 0%, var(--bg) 60%); color:var(--fg); display:flex; align-items:center; justify-content:center; padding:18px; transition:background-color .25s ease; }
    body.ok{ background: radial-gradient(1200px 800px at 50% -10%, #064e3b 0%, #052e27 60%);} /* green */
    body.error{ background: radial-gradient(1200px 800px at 50% -10%, #7f1d1d 0%, #450a0a 60%);}  /* red */
    .app{ width:min(1000px, 100%);} .card{ background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.4); overflow:hidden; }
    header{ display:flex; gap:14px; align-items:center; justify-content:space-between; padding:18px 18px 0; flex-wrap:wrap;}
    .title{ font-size:clamp(20px, 3vw, 28px); font-weight:700; letter-spacing:.2px;}
    .status{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#0b1220; border:1px solid rgba(255,255,255,.08); color:var(--muted); }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--muted); box-shadow:0 0 0 3px rgba(255,255,255,.04) inset; }
    .status.ok{ color:var(--ok); border-color:rgba(16,185,129,.35);} .status.ok .dot{ background:var(--ok);} .status.err{ color:var(--err); border-color:rgba(239,68,68,.35);} .status.err .dot{ background:var(--err);} 
    .body{ display:grid; grid-template-columns:1.1fr .9fr; gap:16px; padding:18px; } @media (max-width:900px){ .body{ grid-template-columns:1fr; }}
    .panel{ background:#0b1220; border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px; }
    .panel h2{ margin:0 0 12px; font-size:16px; color:#cbd5e1; font-weight:600; letter-spacing:.2px; }
    #reader{ width:100%; border-radius:12px; overflow:hidden; background:#000; }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{ appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; letter-spacing:.2px; cursor:pointer; transition:transform .06s ease, opacity .2s ease, box-shadow .2s ease; }
    button:active{ transform:translateY(1px); }
    .primary{ background:var(--btn); color:var(--btnText); box-shadow:0 6px 18px rgba(37,99,235,.35); }
    .secondary{ background:#0f172a; color:#e2e8f0; border:1px solid rgba(255,255,255,.08); }
    .ghost{ background:transparent; color:#cbd5e1; border:1px dashed rgba(255,255,255,.2); }
    button[disabled]{ opacity:.5; cursor:not-allowed; box-shadow:none; }
    .field{ display:grid; gap:6px; margin:10px 0 0; }
    label{ font-size:12px; color:#9aa4b2; }
    input, select, .file{ width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0b1220; color:#e5e7eb; }
    .file{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .log{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:13px; background:#020617; color:#cbd5e1; border-radius:12px; padding:12px; height:180px; overflow:auto; white-space:pre-wrap; border:1px solid rgba(255,255,255,.06); }
    .checkin-banner{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.06); margin-top:12px; }
    .checkin-banner.ok{ background:rgba(16,185,129,.12); } .checkin-banner.err{ background:rgba(239,68,68,.12); }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div class="title">üéüÔ∏è QR Ticket Check‚ÄëIn (html5‚Äëqrcode + CSV)</div>
        <div id="statusPill" class="status" aria-live="polite"><span class="dot"></span><span id="statusText">Upload ticket_ids.csv to begin</span></div>
      </header>

      <div class="body">
        <!-- Scanner panel -->
        <section class="panel">
          <h2>Scanner</h2>
          <div id="reader"></div>
          <div class="controls">
            <select id="cameraSelect" title="Camera"></select>
            <button id="btnStart" class="primary">üì∑ Start Scan</button>
            <button id="btnStop" class="secondary" disabled>‚èπ Stop</button>
          </div>
          <div class="field">
            <label for="qrText">Last scanned value</label>
            <input id="qrText" placeholder="‚Äî" readonly />
          </div>
          <div id="banner" class="checkin-banner" hidden>
            <div id="bannerMsg">‚Äî</div>
          </div>
        </section>

        <!-- CSV + log panel -->
        <section class="panel">
          <h2>CSV & Controls</h2>
          <div class="field">
            <label>ticket_ids.csv (must include columns: <b>ids</b>, <b>status</b>)</label>
            <div class="file">
              <input type="file" id="csvFile" accept=".csv" />
              <button id="btnDownload" class="ghost" disabled>‚¨áÔ∏è Download updated CSV</button>
            </div>
          </div>
          <div class="field">
            <label for="manual">Manual entry (fallback)</label>
            <input id="manual" placeholder="Paste or type a QR value here..." />
          </div>
          <div class="controls">
            <button id="btnValidate" class="secondary">Validate</button>
            <button id="btnReset" class="ghost">Reset</button>
          </div>
          <div class="field">
            <label>Activity</label>
            <div id="log" class="log" aria-live="polite"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/dist/html5-qrcode.min.js"></script>
  <script>
  (function(){
    const els = {
      body: document.body,
      statusPill: document.getElementById('statusPill'),
      statusText: document.getElementById('statusText'),
      reader: document.getElementById('reader'),
      camSel: document.getElementById('cameraSelect'),
      start: document.getElementById('btnStart'),
      stop: document.getElementById('btnStop'),
      qrText: document.getElementById('qrText'),
      banner: document.getElementById('banner'),
      bannerMsg: document.getElementById('bannerMsg'),
      manual: document.getElementById('manual'),
      validate: document.getElementById('btnValidate'),
      reset: document.getElementById('btnReset'),
      log: document.getElementById('log'),
      csvFile: document.getElementById('csvFile'),
      btnDownload: document.getElementById('btnDownload'),
    };

    // In-memory CSV data
    let csvHeaders = [];          // e.g., ['ids','status', ...]
    let csvRows = [];             // array of arrays (excluding header)
    let idCol = -1, statusCol = -1;  
    const map = new Map();        // id -> rowIndex

    // html5-qrcode
    let html5Qr = null;           // Html5Qrcode instance
    let activeCameraId = null;

    function setStatus(text, type = 'idle'){
      els.statusText.textContent = text;
      els.statusPill.classList.remove('ok','err');
      els.body.classList.remove('ok','error');
      if(type === 'ok'){ els.statusPill.classList.add('ok'); els.body.classList.add('ok'); }
      else if(type === 'err'){ els.statusPill.classList.add('err'); els.body.classList.add('error'); }
    }
    function log(msg){ const t = new Date().toLocaleTimeString(); els.log.textContent = `[${t}] ${msg}\n` + els.log.textContent; }
    function showBanner(msg, ok){ els.banner.hidden = false; els.banner.classList.toggle('ok', !!ok); els.banner.classList.toggle('err', !ok); els.bannerMsg.textContent = msg; }

    // CSV utils (simple parser supporting quoted fields)
    function parseCSV(text){
      const rows = []; let row = []; let cur = '';
      let i=0, inQuotes=false;
      while(i < text.length){
        const ch = text[i];
        if(inQuotes){
          if(ch === '"'){
            if(text[i+1] === '"'){ cur += '"'; i++; } else { inQuotes = false; }
          } else { cur += ch; }
        } else {
          if(ch === '"'){ inQuotes = true; }
          else if(ch === ','){ row.push(cur); cur=''; }
          else if(ch === '\n' || ch === '\r'){ if(cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; } if(ch==='\r' && text[i+1]==='\n') i++; }
          else { cur += ch; }
        }
        i++;
      }
      if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
      return rows.filter(r=>r.length && !(r.length===1 && r[0]===''));
    }
    function toCSV(headers, rows){
      const esc = v => (v==null?'':String(v)).replace(/"/g,'""');
      const line = arr => arr.map(v=>`"${esc(v)}"`).join(',');
      return [line(headers), ...rows.map(line)].join('\n');
    }
    function loadCSV(text){
      const table = parseCSV(text);
      if(!table.length) throw new Error('Empty CSV');
      csvHeaders = table[0].map(h=>String(h).trim());
      idCol = csvHeaders.findIndex(h=>h.toLowerCase()==='ids');
      statusCol = csvHeaders.findIndex(h=>h.toLowerCase()==='status');
      if(idCol===-1 || statusCol===-1) throw new Error('Missing required columns: ids, status');
      csvRows = table.slice(1);
      map.clear();
      csvRows.forEach((row, idx)=>{ map.set(String(row[idCol]).trim(), idx); });
      els.btnDownload.disabled = false;
      setStatus('CSV loaded. Ready to scan.');
      log(`Loaded ${csvRows.length} tickets. Columns: ${csvHeaders.join(', ')}`);
    }

    function updateStatusForId(id){
      if(!csvHeaders.length){ setStatus('Upload ticket_ids.csv first', 'err'); showBanner('üìÑ Please upload ticket_ids.csv (with columns: ids, status) to validate scans.', false); log('No CSV loaded; cannot validate: ' + id); return 'no_csv'; }
      const idx = map.get(String(id).trim());
      if(idx === undefined){ setStatus('Invalid QR code', 'err'); showBanner('‚õî Fake/unknown code', false); log(`Code NOT FOUND: ${id}`); return 'not_found'; }
      const current = String(csvRows[idx][statusCol]||'').trim().toLowerCase();
      if(current === 'checked-in' || current === 'checkedin' || current === 'checked_in'){
        setStatus('Already checked in', 'err'); showBanner('‚ö†Ô∏è Code already checked in', false); log(`ALREADY CHECKED IN: ${id}`); return 'already';
      }
      csvRows[idx][statusCol] = 'Checked-In';
      setStatus('Checked in', 'ok'); showBanner('üéâ Checked in', true); log(`Checked in: ${id}`);
      return 'ok';
    }

    // html5-qrcode helpers
    async function listCameras(){
      try{
        const devices = await Html5Qrcode.getCameras();
        els.camSel.innerHTML = '';
        devices.forEach((d,i)=>{
          const opt = document.createElement('option');
          opt.value = d.id; opt.textContent = d.label || `Camera ${i+1}`;
          els.camSel.appendChild(opt);
        });
        // Prefer back camera if label suggests it
        const back = devices.find(d=>/back|rear|environment/i.test(d.label||''));
        activeCameraId = back?.id || devices[0]?.id || null;
        if(activeCameraId){ els.camSel.value = activeCameraId; }
        els.start.disabled = !activeCameraId;
        return devices;
      } catch(err){ log('Camera enumeration failed: '+(err?.message||err)); setStatus('Camera not available', 'err'); els.start.disabled = true; return []; }
    }

    async function startScan(){
      try{ log('Start Scan clicked'); }catch(e){}
      if(html5Qr){ await stopScan(); }
      if(!activeCameraId){ await listCameras(); }
      if(!activeCameraId){ setStatus('No camera found', 'err'); return; }
      html5Qr = new Html5Qrcode('reader', { verbose: false });
      const config = { fps: 12, qrbox: { width: 250, height: 250 }, aspectRatio: 1.333, rememberLastUsedCamera: true, formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ] };
      setStatus('Starting camera‚Ä¶');
      await html5Qr.start({ deviceId: { exact: activeCameraId } }, config,
        onScanSuccess, onScanFailure);
      setStatus('Scanning‚Ä¶'); els.stop.disabled = true; // will enable after first frame
      // html5-qrcode triggers failures rapidly; enable stop once stream is flowing
      setTimeout(()=>{ els.stop.disabled = false; }, 800);
    }
    async function stopScan(){
      try{ if(html5Qr){ await html5Qr.stop(); await html5Qr.clear(); } }catch(e){ /* ignore */ }
      html5Qr = null; setStatus(csvHeaders.length? 'CSV loaded. Ready to scan.' : 'Idle');
      els.stop.disabled = true;
    }

    function onScanSuccess(decodedText, decodedResult){
      els.qrText.value = decodedText;
      updateStatusForId(decodedText);
      // Stop after a successful decode to avoid dupes; toggle to continuous if desired
      stopScan();
    }
    function onScanFailure(err){ /* noisy; keep quiet */ }

    // UI events
    els.start.addEventListener('click', startScan);
    els.stop.addEventListener('click', stopScan);
    els.camSel.addEventListener('change', (e)=>{ activeCameraId = e.target.value; if(html5Qr){ startScan(); } });

    els.validate.addEventListener('click', ()=>{ const val = els.manual.value.trim(); if(!val){ setStatus('Enter a value to validate'); return; } els.qrText.value = val; updateStatusForId(val); });
    els.reset.addEventListener('click', ()=>{ els.qrText.value=''; els.manual.value=''; els.banner.hidden=true; els.body.classList.remove('ok','error'); els.statusPill.classList.remove('ok','err'); setStatus(map.size? 'CSV loaded. Ready to scan.' : 'Upload ticket_ids.csv to begin'); });

    // CSV load + save
    els.csvFile.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0]; if(!file) return;
      try{ const text = await file.text(); loadCSV(text); } catch(err){ setStatus('Failed to load CSV', 'err'); log('CSV error: '+err.message); }
    });
    els.btnDownload.addEventListener('click', ()=>{
      try{ if(!csvHeaders.length) return; const csv = toCSV(csvHeaders, csvRows); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ticket_ids.updated.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000); } catch(err){ log('Download error: '+err.message); }
    });

    // Initial camera list (requires HTTPS/localhost for labels on first load on some browsers)
    if(!(window.isSecureContext || location.hostname==='localhost')){
      log('This page must run on HTTPS or localhost for camera access.');
      setStatus('Camera blocked: use HTTPS or localhost', 'err');
    } else {
      listCameras();
      setStatus('Upload ticket_ids.csv to begin');
    }
  })();
  </script>
</body>
</html>
